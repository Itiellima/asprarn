name: Deploy Laravel + Vite para Locaweb

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Clonar o repositório
      - name: Checkout
        uses: actions/checkout@v3

      # 2️⃣ Instalar dependências PHP
      - name: Install PHP dependencies
        run: composer install --no-dev --optimize-autoloader

      # 3️⃣ Configurar Node e build do Vite
      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install Node dependencies
        run: npm install

      - name: Build Vite assets
        run: npm run build

      # 4️⃣ Preparar pasta temporária para deploy
      - name: Prepare Laravel for Locaweb
        run: |
          mkdir -p temp_deploy
          # Copiar todo o Laravel para temp_deploy, exceto temp_deploy
          rsync -av --progress --exclude 'temp_deploy' ./ temp_deploy/

          # Ajustar public/index.php para paths relativos
          sed -i "s|require __DIR__ . '/../vendor/autoload.php';|require __DIR__ . '/vendor/autoload.php';|g" temp_deploy/public/index.php
          sed -i "s|\\$app = require_once __DIR__ . '/../bootstrap/app.php';|\\$app = require_once __DIR__ . '/bootstrap/app.php';|g" temp_deploy/public/index.php

          # Mover o conteúdo de public para a raiz da pasta temporária
          cp -r temp_deploy/public/* temp_deploy/
          rm -rf temp_deploy/public

          # Remover arquivos desnecessários
          rm -rf temp_deploy/node_modules temp_deploy/.git temp_deploy/tests
          
      - name: Debug secrets
        run: |
          echo "HOST=${{ secrets.HOST }}"
          echo "USER=${{ secrets.USER }}"
          echo "PASS=${{ secrets.PASS }}"

      # 5️⃣ Deploy via FTP
      - name: Deploy to Locaweb
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.PASS }}
          local-dir: temp_deploy
          server-dir: public_html/
          exclude: |
            .git*
            node_modules*
            tests*
